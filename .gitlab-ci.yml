.setup:
  before_script:
    - call C:\Gitlab-Runner\Miniconda3\Library\bin\conda.bat activate
    - conda.exe update --override-channels -c defaults -c conda-forge conda
    - conda.exe config --set show_channel_urls true
    - conda.exe info
    - conda.exe config --remove-key channels
    # I think we are already logged in
    #- call anaconda login --username ramonaoptics --password %ANACONDA_PASSWORD% --hostname gitlab-windows-runner
    - conda.exe config --add channels defaults
    - conda.exe config --add channels conda-forge
    - conda.exe config --add channels ramonaoptics
    - conda.exe install -n root --yes conda-build
    - conda.exe info

run:
  extends: .setup
  tags:
    - windows
  stage: build
  script:
    - conda.exe config --set anaconda_upload no
    - conda.exe build .

static_checking:
  extends: .setup
  tags:
    - windows
  stage: test
  script:
    # - conda.exe remove --name owl-runner --all --force --yes --offline
    - conda.exe create --name owl-runner --yes flake8 mypy
    - call activate.bat owl-runner
    - python.exe -m flake8 pyilluminate setup.py
    - python.exe -m mypy pyilluminate


conda_deploy:
  # Only deploy if a new tag is created
  only:
    - tags
  tags:
    - windows
  stage: deploy
  extends: .setup
  script:
    - conda.exe config --set anaconda_upload yes
    - conda.exe build .
    - conda.exe config --set anaconda_upload no

.setup_linux:
  image: condaforge/linux-anvil-comp7
  tags:
    - linux
  before_script:
    - conda config --set show_channel_urls true
    - conda config --remove-key channels
    - conda config --add channels defaults
    - conda config --add channels conda-forge
    - conda config --add channels https://conda.anaconda.org/t/${BINSTAR_TOKEN_READONLY}/ramonaoptics
    - conda install -n root --yes conda-build conda conda-forge-ci-setup
    - conda config --set anaconda_upload no
    - conda config --show
    - git submodule init
    - git submodule update
    # Don't know why this is needed, but it is
    # https://github.com/ContinuumIO/anaconda-issues/issues/9190#issuecomment-384697849
    - sudo yum install -y mesa-libGL.x86_64

build_linux:
  extends: .setup_linux
  stage: build
  script:
    - conda build .

static_checking:
  extends: .setup_linux
  stage: test
  script:
    - conda create --name owl-runner --yes flake8 mypy
    - conda activate owl-runner
    - python -m flake8 pyilluminate setup.py
    - python -m mypy pyilluminate

deploy_linux:
  extends: .setup_linux
  stage: deploy
  only:
    - tags
  script:
    # tests were already run in the previous step, this just avoid the need for artifacts.
    - conda build --no-test .
    - upload_or_check_non_existence . ramonaoptics
